<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Document Load Instrumentation Example</title>
  <base href="/" />
  <!--
      https://www.w3.org/TR/trace-context/
      Set the `traceparent` in the server's HTML template code. It should be
      dynamically generated server side to have the server's request trace Id,
      a parent span Id that was set on the server's request span, and the trace
      flags to indicate the server's sampling decision
      (01 = sampled, 00 = not sampled).
      '{version}-{traceId}-{spanId}-{sampleDecision}'
    -->
  <meta name="traceparent" content="00-ab42124a3c573678d4d8b21ba52df3bf-d21f7bc17caa5aba-01" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="browser.js" type="text/javascript"></script>

  <script>
    console.log('loaded browser.js');
    window.dataBuffOpenTelemetryRum.initialize({
      collectionSourceUrl: 'https://api.databuff.com',
      serviceName: 'testName',
      applicationName: 'appName',
      UserActivation: true,
      propagateTraceHeaderCorsUrls: [
        'list_of_domains_to_receive_trace_context',
      ],
      collectErrors: true,
      collectSessionId: true,
      dropSingleUserInteractionTraces: false,
    });


  </script>

</head>
<h1>H1 Document Load Instrumentation Example</h1>

<body>


  Example of using Web Tracer with document load instrumentation with console
  exporter and collector exporter

  <button id="codeErr" onclick="codeError()">代码错误</button>
  <button id="normalReq" onclick="onClickXhrNormal()">xhr正常请求</button>
  <button id="exceptionReq" onclick="onClickXhrError()">xhr异常请求</button>

  <button id="normalFetch" onclick="onClickNativeFetch()">Fetch正常请求</button>
  <button id="exceptionFetch" onclick="onClickNativeErrorFetch()">Fetch异常请求</button>
  <button id="logUpload" onclick="mitoLog()">log上报</button>
  <button id="promiseError" onclick="promiseError()">promiseError</button>

  <a href="newTest.html" target="_blank" rel="noopener noreferrer">跳转到另一个页面</a>

  <script type="module" src="document-load.js"></script>

  <script>
    function codeError() {
      let a = {}
      a.split('/')
    }

    function onClickXhrNormal() {
      console.log('12312')
      const xhr = new XMLHttpRequest()
      xhr.open('get', '/normal')
      xhr.setRequestHeader('content-type', 'application/json')
      xhr.send()
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4) {
          console.log(xhr.responseType);
          console.log("onClickXhrNormal");
        }
      }
    }
    function onClickXhrError() {
      const xhr = new XMLHttpRequest()
      xhr.open('get', '/exception')
      xhr.setRequestHeader('content-type', 'application/json')
      xhr.send()
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4) {
          // console.log(xhr.responseText)
          console.log("onClickXhrError");
        }
      }
    }
    function onClickNativeFetch() {
      fetch('/normal/post', {
        method: 'POST',
        body: JSON.stringify({ test: '测试请求体' }),
        mode: 'cors',
        headers: {
          'Content-Type': 'application/json'
        }
      }).then((res) => {
        res.text().then((res) => console.log('res', res))
      })
    }
    function onClickNativeErrorFetch() {
      fetch('/exception/post', {
        method: 'POST',
        body: JSON.stringify({ test: '测试请求体' }),
        mode: 'cors',
        headers: {
          'Content-Type': 'application/json'
        }
      }).then(
        (res) => {
          res.text().then((res) => console.log('res', res))
        },
        (err) => {
          console.log('err', err)
        }
      )
    }

    function mitoLog() {
      window._MITO_.log({ message: { one: 111 }, tag: '测试' })
    }

    function promiseError() {
      const promiseWrap = () =>
        new Promise((resolve, reject) => {
          reject('promise reject')
        })
      promiseWrap().then((res) => {
        console.log('res', res)
      })
    }

  </script>

</body>


</html>